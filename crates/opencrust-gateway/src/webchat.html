<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>OpenCrust Chat</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Archivo:wght@500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap");

    :root {
      --bg: #f3ecdf;
      --bg-accent: #e8decc;
      --ink: #2f2416;
      --ink-soft: #6c5a42;
      --panel: #fffaf1;
      --panel-2: #f7ebd8;
      --panel-edge: #d8c3a5;
      --elev: 0 14px 30px rgba(91, 68, 38, 0.18);
      --brand: #7f5a31;
      --brand-2: #ad7d47;
      --online: #2d7e4d;
      --offline: #8f7a5f;
      --sys: #ece0ce;
      --assistant: #fffdf8;
      --error: #f8e2d5;
      --error-edge: #c28b6e;
      --sand-1: #ecdec8;
      --sand-2: #f7efe2;
      --accent-line: rgba(127, 90, 49, 0.24);
      --topbar: rgba(255, 247, 233, 0.88);
      --glow-a: rgba(255, 255, 255, 0.76);
      --glow-b: rgba(208, 166, 105, 0.35);
      --user-grad-a: #6a4d2f;
      --user-grad-b: #4a341e;
      --warn-edge: #cfaa62;
      --warn-bg: #f8efd8;
      --warn-text: #6b5300;
    }

    [data-theme="dark"] {
      --bg: #191510;
      --bg-accent: #110f0d;
      --ink: #f1e4d0;
      --ink-soft: #c1ab8d;
      --panel: #241d16;
      --panel-2: #1a1510;
      --panel-edge: #4f3d2b;
      --elev: 0 16px 34px rgba(0, 0, 0, 0.42);
      --brand: #d7a467;
      --brand-2: #ad7841;
      --online: #84d69c;
      --offline: #a68f72;
      --sys: #302519;
      --assistant: #2b2219;
      --error: #452a1f;
      --error-edge: #9d6649;
      --sand-1: #2e241b;
      --sand-2: #201912;
      --accent-line: rgba(215, 164, 103, 0.32);
      --topbar: rgba(37, 31, 24, 0.9);
      --glow-a: rgba(255, 205, 140, 0.09);
      --glow-b: rgba(0, 0, 0, 0.2);
      --user-grad-a: #7b5631;
      --user-grad-b: #5b3f25;
      --warn-edge: #8b6c36;
      --warn-bg: #322514;
      --warn-text: #e2c68b;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      color: var(--ink);
      font-family: "Archivo", "Segoe UI", sans-serif;
      background:
        radial-gradient(1000px 620px at 0% -15%, var(--glow-a) 0%, transparent 58%),
        radial-gradient(1000px 620px at 100% -15%, var(--glow-b) 0%, transparent 58%),
        linear-gradient(180deg, var(--bg), var(--bg-accent));
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 320ms ease, transform 320ms ease, background 360ms ease, color 240ms ease;
    }

    body.ready {
      opacity: 1;
      transform: translateY(0);
    }

    .shell {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    .left-sidebar {
      width: 260px;
      background: var(--topbar);
      border-right: 1px solid var(--panel-edge);
      display: flex;
      flex-direction: column;
      padding: 20px 16px;
      gap: 8px;
    }

    .left-sidebar .brand {
      margin-bottom: 24px;
    }

    .nav-item {
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--ink-soft);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid transparent;
    }

    .nav-item:hover {
      background: var(--sand-1);
      color: var(--ink);
    }

    .nav-item.active {
      background: linear-gradient(145deg, var(--brand-2), var(--brand));
      color: #fff8ee;
      box-shadow: 0 4px 12px rgba(57, 34, 13, 0.2);
      border-color: var(--brand);
    }

    .main-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 24px;
      overflow-y: auto;
      gap: 16px;
    }

    .topbar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border: 1px solid var(--panel-edge);
      border-radius: 14px;
      background: var(--topbar);
      box-shadow: 0 8px 20px rgba(35, 22, 10, 0.12);
      min-height: 52px;
    }

    .topbar-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nano-agents {
      position: relative;
      display: none;
      align-items: center;
      gap: 12px;
      align-self: flex-start;
      background: var(--assistant);
      padding: 8px 12px;
      border-radius: 14px;
      border: 1px solid var(--panel-edge);
      box-shadow: 0 6px 14px rgba(59, 38, 17, 0.12);
      overflow: hidden;
      contain: layout paint;
      min-height: 34px;
      max-width: fit-content;
    }

    .nano-bg {
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0.2;
    }

    .nano-bit {
      position: absolute;
      border-radius: 50%;
      background: var(--brand);
      transition: opacity 1s ease;
    }

    .nano-grid {
      position: relative;
      width: 22px;
      height: 22px;
      flex-shrink: 0;
      z-index: 1;
    }

    .nano-agent {
      position: absolute;
      width: 10px;
      height: 10px;
      transition: transform 1s ease-in-out;
      padding: 0.5px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 1px;
      border: 1px solid rgba(0, 0, 0, 0.05);
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.03);
    }

    [data-theme="dark"] .nano-agent {
      background: rgba(40, 30, 20, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .nano-pixel {
      width: 100%;
      height: 100%;
      opacity: 0.8;
      transition: background-color 0.2s, opacity 0.2s;
    }

    .nano-text {
      display: flex;
      align-items: baseline;
      gap: 8px;
      z-index: 1;
      padding-right: 2px;
    }

    .nano-label {
      color: var(--ink);
      font-weight: 600;
      font-size: 0.82rem;
      line-height: 1;
    }

    .nano-time {
      color: var(--ink-soft);
      font-size: 0.68rem;
      font-weight: 500;
      font-variant-numeric: tabular-nums;
      opacity: 0.9;
    }

    .theme-toggle {
      padding: 6px 10px;
      font-size: 0.77rem;
      border-radius: 999px;
      border-color: var(--panel-edge);
      background: var(--panel);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .badge {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      border: 2px solid var(--panel-edge);
      background:
        radial-gradient(circle at 30% 30%, #4d4d4d 0%, transparent 45%),
        linear-gradient(145deg, var(--brand), var(--brand-2));
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.28);
    }

    .title {
      margin: 0;
      font-size: 1.35rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .subtitle {
      margin: 0;
      color: var(--ink-soft);
      font-size: 0.78rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .workspace {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 300px;
      gap: 14px;
      align-items: stretch;
      flex: 1;
      min-height: 0;
    }

    .panel-view {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .panel {
      border: 1px solid var(--panel-edge);
      border-radius: 16px;
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      box-shadow: var(--elev);
      overflow: hidden;
      animation: rise 360ms ease both;
      position: relative;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: 0 0 auto;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--accent-line), transparent);
      pointer-events: none;
    }

    .panel-head {
      padding: 14px 16px;
      border-bottom: 1px solid var(--panel-edge);
      background: var(--sand-1);
    }

    .panel-art {
      display: block;
      width: 95%;
      max-height: 148px;
      object-fit: contain;
      border-radius: 12px;
      border: 1px solid var(--panel-edge);
      margin: 0 auto 10px;
      background: var(--panel);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
    }

    .panel-head h2 {
      margin: 0;
      font-size: 1rem;
      letter-spacing: 0.25px;
    }

    .hint {
      margin: 6px 0 0;
      color: var(--ink-soft);
      font-size: 0.82rem;
      line-height: 1.35;
    }

    .sidebar-body {
      padding: 14px;
      display: grid;
      gap: 14px;
    }

    .status-group {
      display: grid;
      gap: 8px;
    }

    .status-group h3 {
      margin: 0;
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--ink-soft);
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.83rem;
      color: var(--ink-soft);
    }

    .status-row code {
      color: var(--brand);
      font-family: "IBM Plex Mono", Consolas, monospace;
      font-size: 0.78rem;
      text-align: right;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 150px;
    }

    .status-dot {
      display: inline-block;
      width: 7px;
      height: 7px;
      border-radius: 50%;
      margin-right: 4px;
    }

    .dot-ok {
      background: var(--online);
    }

    .dot-off {
      background: var(--offline);
    }

    .dot-warn {
      background: #d4a017;
    }

    .channel-list {
      display: grid;
      gap: 4px;
    }

    .channel-tag {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 9px;
      border: 1px solid var(--panel-edge);
      border-radius: 8px;
      font-size: 0.78rem;
      background: var(--panel);
    }

    .no-channels {
      color: var(--ink-soft);
      font-size: 0.8rem;
      font-style: italic;
    }

    .gateway-key-section {
      display: grid;
      gap: 6px;
    }

    .gateway-key-section label {
      font-size: 0.82rem;
      color: var(--ink-soft);
      font-weight: 500;
    }

    .gateway-key-section input {
      width: 100%;
      border: 1px solid var(--panel-edge);
      border-radius: 10px;
      color: var(--ink);
      background: var(--panel);
      padding: 8px 10px;
      font-family: "IBM Plex Mono", Consolas, monospace;
      font-size: 0.82rem;
      transition: border-color 120ms ease, box-shadow 120ms ease;
    }

    .gateway-key-section input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(127, 90, 49, 0.2);
    }

    .gateway-key-section .hint {
      font-size: 0.76rem;
      margin: 0;
    }

    .provider-select {
      width: 100%;
      border: 1px solid var(--panel-edge);
      border-radius: 10px;
      color: var(--ink);
      background: var(--panel);
      padding: 8px 10px;
      font-family: "Archivo", "Segoe UI", sans-serif;
      font-size: 0.84rem;
      cursor: pointer;
      transition: border-color 120ms ease, box-shadow 120ms ease;
      appearance: auto;
    }

    .provider-select:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(127, 90, 49, 0.2);
    }

    .provider-status {
      font-size: 0.78rem;
      color: var(--ink-soft);
      min-height: 1.2em;
    }

    .provider-model-label {
      display: block;
      font-size: 0.78rem;
      color: var(--ink-soft);
      margin-top: 2px;
    }

    .provider-model-input {
      width: 100%;
      border: 1px solid var(--panel-edge);
      border-radius: 10px;
      color: var(--ink);
      background: var(--panel);
      padding: 8px 10px;
      font-family: "IBM Plex Mono", Consolas, monospace;
      font-size: 0.82rem;
      transition: border-color 120ms ease, box-shadow 120ms ease;
    }

    .provider-model-input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(127, 90, 49, 0.2);
    }

    .provider-model-status {
      font-size: 0.74rem;
      color: var(--ink-soft);
      min-height: 1.1em;
    }

    .provider-key-input {
      width: 100%;
      border: 1px solid var(--panel-edge);
      border-radius: 10px;
      color: var(--ink);
      background: var(--panel);
      padding: 8px 10px;
      font-family: "IBM Plex Mono", Consolas, monospace;
      font-size: 0.82rem;
      margin-bottom: 6px;
      transition: border-color 120ms ease, box-shadow 120ms ease;
    }

    .provider-key-input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(127, 90, 49, 0.2);
    }

    .provider-activate-btn {
      width: 100%;
      border: 1px solid var(--brand);
      color: #fff8ee;
      background: linear-gradient(145deg, var(--brand-2), var(--brand));
      box-shadow: 0 6px 14px rgba(57, 34, 13, 0.3);
      border-radius: 10px;
      padding: 8px 12px;
      font-family: "Archivo", "Segoe UI", sans-serif;
      font-size: 0.84rem;
      font-weight: 600;
      cursor: pointer;
    }

    .pill {
      border: 1px solid var(--panel-edge);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.8rem;
      background: var(--panel);
      min-width: 118px;
      text-align: center;
    }

    .online {
      color: var(--online);
      font-weight: 700;
    }

    .offline {
      color: var(--offline);
      font-weight: 700;
    }

    .chat-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      border-bottom: 1px solid var(--panel-edge);
      background: var(--sand-1);
      flex-wrap: wrap;
    }

    .chat-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      color: var(--ink-soft);
      font-size: 0.84rem;
    }

    .chat {
      flex: 1;
      overflow-y: auto;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 11px;
      background: var(--sand-2);
      min-height: 0;
    }

    .placeholder-view {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--ink-soft);
      font-size: 1.1rem;
      background: var(--sand-2);
      padding: 32px;
    }

    .msg {
      max-width: min(86%, 760px);
      border: 1px solid var(--panel-edge);
      border-radius: 14px;
      padding: 10px 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.42;
      box-shadow: 0 6px 14px rgba(59, 38, 17, 0.12);
      animation: msg-in 220ms ease both;
    }

    .sys {
      align-self: center;
      background: var(--sys);
      color: var(--ink-soft);
      font-size: 0.82rem;
      border-style: dashed;
      box-shadow: none;
    }

    .user {
      align-self: flex-end;
      color: #fff7e9;
      border-color: var(--brand);
      background: linear-gradient(145deg, var(--user-grad-a), var(--user-grad-b));
    }

    .assistant {
      align-self: flex-start;
      background: var(--assistant);
      white-space: normal;
    }

    .assistant p {
      margin: 0 0 0.65rem;
    }

    .assistant p:last-child {
      margin-bottom: 0;
    }

    .assistant h1,
    .assistant h2,
    .assistant h3,
    .assistant h4,
    .assistant h5,
    .assistant h6 {
      margin: 0.25rem 0 0.5rem;
      line-height: 1.25;
    }

    .assistant h1 {
      font-size: 1.18rem;
    }

    .assistant h2 {
      font-size: 1.1rem;
    }

    .assistant h3 {
      font-size: 1.02rem;
    }

    .assistant ul {
      margin: 0.25rem 0 0.65rem 1.2rem;
      padding: 0;
    }

    .assistant li {
      margin: 0.2rem 0;
    }

    .assistant blockquote {
      margin: 0.35rem 0 0.65rem;
      padding: 0.15rem 0.75rem;
      border-left: 3px solid var(--panel-edge);
      color: var(--ink-soft);
    }

    .assistant code {
      font-family: "IBM Plex Mono", Consolas, monospace;
      font-size: 0.86em;
      background: var(--sand-1);
      border: 1px solid var(--panel-edge);
      border-radius: 6px;
      padding: 0.05rem 0.35rem;
    }

    .assistant pre {
      margin: 0.35rem 0 0.7rem;
      padding: 0.55rem 0.7rem;
      border-radius: 10px;
      border: 1px solid var(--panel-edge);
      background: var(--sand-1);
      overflow-x: auto;
      white-space: pre;
    }

    .assistant pre code {
      background: none;
      border: none;
      padding: 0;
      border-radius: 0;
      font-size: 0.84rem;
    }

    .assistant a {
      color: var(--brand);
    }

    .assistant .md-table-wrap {
      margin: 0.35rem 0 0.7rem;
      overflow-x: auto;
    }

    .assistant table {
      width: 100%;
      min-width: 320px;
      border-collapse: collapse;
    }

    .assistant th,
    .assistant td {
      border: 1px solid var(--panel-edge);
      padding: 0.35rem 0.5rem;
      vertical-align: top;
    }

    .assistant th {
      background: var(--sand-1);
      font-weight: 600;
      text-align: left;
    }

    .assistant .md-align-right {
      text-align: right;
    }

    .assistant .md-align-center {
      text-align: center;
    }

    .error {
      align-self: flex-start;
      background: var(--error);
      border-color: var(--error-edge);
      color: var(--ink);
    }

    .controls {
      border-top: 1px solid var(--panel-edge);
      padding: 14px;
      display: grid;
      gap: 10px;
      background: var(--sand-1);
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      border: 1px solid var(--panel-edge);
      border-radius: 10px;
      background: var(--panel);
      color: var(--ink);
      padding: 8px 12px;
      font-family: "Archivo", "Segoe UI", sans-serif;
      font-size: 0.84rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease;
    }

    button:hover {
      transform: translateY(-1px);
      border-color: var(--brand-2);
      box-shadow: 0 7px 14px rgba(0, 0, 0, 0.12);
    }

    button.primary {
      border-color: var(--brand);
      color: #fff8ee;
      background: linear-gradient(145deg, var(--brand-2), var(--brand));
      box-shadow: 0 10px 18px rgba(57, 34, 13, 0.35);
    }

    .composer {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: end;
    }

    textarea {
      width: 100%;
      min-height: 66px;
      max-height: 190px;
      resize: vertical;
      border: 1px solid var(--panel-edge);
      border-radius: 10px;
      color: var(--ink);
      background: var(--panel);
      padding: 10px 11px;
      font-family: "IBM Plex Mono", Consolas, monospace;
      font-size: 0.9rem;
      line-height: 1.4;
      transition: border-color 120ms ease, box-shadow 120ms ease;
    }

    textarea:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(127, 90, 49, 0.2);
    }

    .divider {
      border: none;
      border-top: 1px solid var(--panel-edge);
      margin: 2px 0;
    }

    .update-banner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      margin-bottom: 12px;
      border: 1px solid var(--warn-edge);
      border-radius: 12px;
      background: linear-gradient(145deg, var(--warn-bg), var(--panel-2));
      font-size: 0.84rem;
      color: var(--warn-text);
      animation: rise 360ms ease both;
    }

    .update-banner a {
      color: var(--brand);
      font-weight: 600;
      text-decoration: none;
    }

    .update-banner a:hover {
      text-decoration: underline;
    }

    .update-banner-close {
      cursor: pointer;
      opacity: 0.7;
    }

    .update-banner-close:hover {
      opacity: 1;
    }

    /* Settings Cards & Forms */
    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--panel-edge);
      background: var(--sand-1);
    }

    .settings-header h2 {
      margin: 0;
      font-size: 1.1rem;
    }

    .settings-body {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
    }

    .card {
      border: 1px solid var(--panel-edge);
      border-radius: 12px;
      background: var(--panel);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-weight: 600;
      font-size: 1rem;
      margin: 0;
    }

    .card-meta {
      font-family: "IBM Plex Mono", monospace;
      font-size: 0.8rem;
      color: var(--ink-soft);
      background: var(--sand-2);
      padding: 6px 10px;
      border-radius: 6px;
      word-break: break-all;
    }

    .card-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
      border-top: 1px solid var(--panel-edge);
      padding-top: 12px;
    }

    .card-actions button {
      font-size: 0.75rem;
      padding: 6px 10px;
    }

    .btn-danger {
      color: var(--error-edge);
      border-color: var(--error-edge);
    }

    .btn-danger:hover {
      background: var(--error);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--ink-soft);
      background: var(--sand-2);
      border-radius: 12px;
      border: 1px dashed var(--panel-edge);
    }

    .topbar,
    .panel,
    .panel-head,
    .chat-top,
    .chat,
    .controls,
    .msg,
    button,
    .pill,
    .gateway-key-section input,
    .provider-select,
    .provider-model-input,
    .provider-key-input,
    textarea,
    .channel-tag,
    .update-banner {
      transition: background 280ms ease, border-color 280ms ease, color 220ms ease, box-shadow 280ms ease;
    }

    @keyframes rise {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes msg-in {
      from {
        opacity: 0;
        transform: translateY(5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 980px) {
      .shell {
        padding: 14px;
      }

      .workspace {
        grid-template-columns: 1fr;
      }

      .chat {
        min-height: 44vh;
        max-height: 56vh;
      }

      .composer {
        grid-template-columns: 1fr;
      }

      .composer button {
        width: 100%;
      }

      .nano-label {
        font-size: 0.72rem;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      body {
        opacity: 1;
        transform: none;
        transition: none;
      }

      .panel,
      .msg,
      .update-banner {
        animation: none;
      }

      .topbar,
      .panel,
      .panel-head,
      .chat-top,
      .chat,
      .controls,
      .msg,
      button,
      .pill,
      .gateway-key-section input,
      .provider-select,
      .provider-model-input,
      .provider-key-input,
      textarea,
      .channel-tag,
      .update-banner {
        transition: none;
      }

      .nano-bit,
      .nano-agent,
      .nano-pixel {
        transition: none;
      }
    }
  </style>
</head>

<body>
  <main class="shell">
    <!-- Left Sidebar for Navigation -->
    <aside class="left-sidebar">
      <div class="brand">
        <div class="badge"></div>
        <div>
          <h1 class="title">OpenCrust</h1>
          <p class="subtitle">Your personal AI assistant</p>
        </div>
      </div>

      <div class="nav-item active" id="nav-chat">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        Chat
      </div>

      <div class="nav-item" id="nav-mcps">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
          <line x1="8" y1="21" x2="16" y2="21"></line>
          <line x1="12" y1="17" x2="12" y2="21"></line>
        </svg>
        MCPs Settings
      </div>

      <div class="nav-item" id="nav-extensions">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path
            d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
          </path>
          <polyline points="7.5 4.21 12 6.81 16.5 4.21"></polyline>
          <polyline points="7.5 19.79 7.5 14.6 3 12"></polyline>
          <polyline points="21 12 16.5 14.6 16.5 19.79"></polyline>
          <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
          <line x1="12" y1="22.08" x2="12" y2="12"></line>
        </svg>
        Extensions
      </div>
    </aside>

    <div class="main-wrapper">
      <header class="topbar">
        <div class="topbar-actions">
          <button id="theme-toggle" class="theme-toggle" type="button">Dark Mode</button>
          <div class="pill" id="conn-pill"><span class="offline">Disconnected</span></div>
        </div>
      </header>

      <div id="update-banner" class="update-banner" style="display:none">
        <span id="update-banner-text"></span>
        <button class="update-banner-close" id="update-banner-close" title="Dismiss">&times;</button>
      </div>

      <div class="workspace">
        <section class="panel panel-view" id="view-chat">
          <div class="chat-top">
            <div class="chat-meta">
              <span>Chat</span>
              <span>Enter sends, Shift+Enter newline</span>
            </div>
            <div class="actions">
              <button id="reconnect">Reconnect</button>
              <button id="clear">New Chat</button>
            </div>
          </div>

          <div id="chat" class="chat">
            <div id="nano-agents" class="nano-agents" aria-live="polite">
              <div class="nano-bg" id="nano-bg"></div>
              <div class="nano-grid" id="nano-grid"></div>
              <div class="nano-text">
                <span class="nano-label">Typing...</span>
                <span id="nano-time" class="nano-time">0s</span>
              </div>
            </div>
          </div>

          <div class="controls">
            <div class="composer">
              <textarea id="input" placeholder="Type a message..."></textarea>
              <button id="send" class="primary">Send</button>
            </div>
          </div>
        </section>

        <!-- Structural Mockup for MCPs View -->
        <section class="panel panel-view" id="view-mcps" style="display: none;">
          <div class="settings-header">
            <h2>MCPs Settings</h2>
            <div class="actions">
              <button class="primary" id="add-mcp-btn">Add New MCP</button>
            </div>
          </div>
          <div class="settings-body" id="mcps-list">
            <!-- Mocked Active MCP -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">server-filesystem</h3>
                <span class="pill online">Running</span>
              </div>
              <div class="card-meta">npx -y @modelcontextprotocol/server-filesystem /tmp</div>
              <div class="card-actions">
                <button>Restart</button>
                <button class="btn-danger">Remove</button>
              </div>
            </div>

            <!-- Mocked Stopped MCP -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">server-github</h3>
                <span class="pill offline">Stopped</span>
              </div>
              <div class="card-meta">npx -y @modelcontextprotocol/server-github</div>
              <div class="card-actions">
                <button>Start</button>
                <button class="btn-danger">Remove</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Structural Mockup for Extensions View -->
        <section class="panel panel-view" id="view-extensions" style="display: none;">
          <div class="settings-header">
            <h2>Extensions</h2>
            <div class="actions">
              <button class="primary" id="add-extension-btn">Install Extension</button>
            </div>
          </div>
          <div class="settings-body" id="extensions-list">
            <!-- Mocked empty state Example, or a single extension -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Code Review Assistant</h3>
                <span class="pill online">Enabled</span>
              </div>
              <div class="card-meta">Provides automated PR reviews and style checks.</div>
              <div class="card-actions">
                <button>Configure</button>
                <button>Disable</button>
                <button class="btn-danger">Uninstall</button>
              </div>
            </div>

            <div class="empty-state" style="display: none;">
              <p>No extensions installed.</p>
              <button class="primary">Browse Extensions</button>
            </div>
          </div>
        </section>
        <aside class="panel">
          <div class="panel-head">
            <img class="panel-art" src="/assets/UI%20Crab.png" alt="OpenCrust UI crab">
            <h2>System Status</h2>
          </div>
          <div class="sidebar-body">
            <div class="status-group">
              <h3>Gateway</h3>
              <div class="status-row">
                <span>Server</span>
                <code id="api-status">checking...</code>
              </div>
              <div class="status-row">
                <span>Session</span>
                <code id="session">none</code>
              </div>
              <div class="status-row">
                <span>Active sessions</span>
                <code id="session-count">-</code>
              </div>
            </div>

            <hr class="divider">

            <div class="status-group">
              <h3>Channels</h3>
              <div id="channel-list" class="channel-list">
                <span class="no-channels">No channels connected</span>
              </div>
            </div>

            <hr class="divider">

            <div class="status-group">
              <h3>LLM Provider</h3>
              <select id="provider-select" class="provider-select">
                <option value="">Loading...</option>
              </select>
              <div id="provider-status" class="provider-status"></div>
              <label for="provider-model-input" class="provider-model-label">Model (optional)</label>
              <input id="provider-model-input" class="provider-model-input" list="provider-model-options"
                placeholder="Provider default model" autocomplete="off">
              <datalist id="provider-model-options"></datalist>
              <div id="provider-model-status" class="provider-model-status"></div>
              <div id="provider-key-section" style="display:none">
                <input id="provider-api-key" type="password" placeholder="Enter API key..." autocomplete="off"
                  class="provider-key-input">
                <button id="provider-activate" class="provider-activate-btn">Save & Activate</button>
              </div>
            </div>

            <div id="auth-section" class="gateway-key-section" style="display:none">
              <hr class="divider">
              <label for="key-gateway">Gateway API Key</label>
              <input id="key-gateway" type="password" placeholder="Enter your gateway key" autocomplete="off">
              <p class="hint">This gateway requires authentication.</p>
              <button id="auth-connect">Connect</button>
            </div>

            <div class="actions">
              <button id="refresh">Refresh Status</button>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <script>
    const chatEl = document.getElementById("chat");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const reconnectBtn = document.getElementById("reconnect");
    const refreshBtn = document.getElementById("refresh");
    const clearBtn = document.getElementById("clear");
    const connPill = document.getElementById("conn-pill");
    const themeToggleBtn = document.getElementById("theme-toggle");
    const sessionEl = document.getElementById("session");
    const apiStatusEl = document.getElementById("api-status");
    const sessionCountEl = document.getElementById("session-count");
    const channelListEl = document.getElementById("channel-list");
    const providerSelect = document.getElementById("provider-select");
    const providerStatus = document.getElementById("provider-status");
    const providerModelInput = document.getElementById("provider-model-input");
    const providerModelOptions = document.getElementById("provider-model-options");
    const providerModelStatus = document.getElementById("provider-model-status");
    const providerKeySection = document.getElementById("provider-key-section");
    const providerApiKey = document.getElementById("provider-api-key");
    const providerActivateBtn = document.getElementById("provider-activate");
    const authSection = document.getElementById("auth-section");
    const keyGatewayEl = document.getElementById("key-gateway");
    const authConnectBtn = document.getElementById("auth-connect");
    const updateBanner = document.getElementById("update-banner");
    const updateBannerText = document.getElementById("update-banner-text");
    const updateBannerClose = document.getElementById("update-banner-close");

    const storageKey = "opencrust.session_id";
    const keyStorage = "opencrust.gateway_key";
    const providerStorage = "opencrust.provider";
    const providerModelStorage = "opencrust.provider_models";
    const themeStorageKey = "opencrust.ui.theme";
    let sessionId = localStorage.getItem(storageKey) || "";
    let gatewayKey = localStorage.getItem(keyStorage) || "";
    let selectedProvider = localStorage.getItem(providerStorage) || "";
    let authRequired = false;
    let socket = null;
    let reconnectTimer = null;
    let providerData = [];
    let selectedModelsByProvider = {};
    let nanoTimerInterval = null;
    let nanoElapsed = 0;
    let thinkingTimeout = null;

    // Pre-fill saved key
    keyGatewayEl.value = gatewayKey;
    try {
      const rawModels = localStorage.getItem(providerModelStorage);
      if (rawModels) {
        const parsed = JSON.parse(rawModels);
        if (parsed && typeof parsed === "object") {
          selectedModelsByProvider = parsed;
        }
      }
    } catch {
      selectedModelsByProvider = {};
    }

    function saveProviderModels() {
      localStorage.setItem(providerModelStorage, JSON.stringify(selectedModelsByProvider));
    }

    function setSavedModelForProvider(providerId, model) {
      if (!providerId) return;
      if (model) {
        selectedModelsByProvider[providerId] = model;
      } else {
        delete selectedModelsByProvider[providerId];
      }
      saveProviderModels();
    }

    function getSavedModelForProvider(providerId) {
      if (!providerId) return "";
      const value = selectedModelsByProvider[providerId];
      return typeof value === "string" ? value : "";
    }

    function setTheme(theme, persist = true) {
      const selected = theme === "dark" ? "dark" : "light";
      document.documentElement.setAttribute("data-theme", selected);
      if (themeToggleBtn) {
        themeToggleBtn.textContent = selected === "dark" ? "Light Mode" : "Dark Mode";
      }
      if (persist) {
        localStorage.setItem(themeStorageKey, selected);
      }
    }

    function initTheme() {
      const stored = localStorage.getItem(themeStorageKey);
      if (stored === "light" || stored === "dark") {
        setTheme(stored, false);
        return;
      }
      const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      setTheme(prefersDark ? "dark" : "light");
    }

    function wsUrl() {
      const proto = location.protocol === "https:" ? "wss:" : "ws:";
      const base = `${proto}//${location.host}/ws`;
      const key = gatewayKey || keyGatewayEl.value.trim();
      return key ? `${base}?token=${encodeURIComponent(key)}` : base;
    }

    function setConnectionState(isConnected) {
      connPill.innerHTML = isConnected
        ? '<span class="online">Connected</span>'
        : '<span class="offline">Disconnected</span>';
    }

    function setSession(id) {
      sessionId = id || "";
      if (sessionId) {
        localStorage.setItem(storageKey, sessionId);
        sessionEl.textContent = sessionId.slice(0, 8) + "...";
        sessionEl.title = sessionId;
      } else {
        localStorage.removeItem(storageKey);
        sessionEl.textContent = "none";
        sessionEl.title = "";
      }
    }

    function escapeHtml(value) {
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function sanitizeUrl(rawUrl) {
      const candidate = String(rawUrl || "").trim();
      if (!candidate) return null;
      if (candidate.startsWith("/") || candidate.startsWith("#")) {
        return candidate;
      }
      try {
        const parsed = new URL(candidate, window.location.origin);
        if (["http:", "https:", "mailto:"].includes(parsed.protocol)) {
          return parsed.href;
        }
      } catch {
        // Ignore invalid URLs.
      }
      return null;
    }

    function renderInlineMarkdown(input) {
      const replacements = [];
      let text = String(input || "");

      text = text.replace(/`([^`]+)`/g, (_, code) => {
        const idx = replacements.push(`<code>${escapeHtml(code)}</code>`) - 1;
        return `\u0000${idx}\u0000`;
      });

      text = text.replace(/\[([^\]]+)\]\(([^)\s]+)\)/g, (_, label, href) => {
        const safeHref = sanitizeUrl(href);
        const safeLabel = escapeHtml(label);
        const html = safeHref
          ? `<a href="${escapeHtml(safeHref)}" target="_blank" rel="noopener noreferrer">${safeLabel}</a>`
          : safeLabel;
        const idx = replacements.push(html) - 1;
        return `\u0000${idx}\u0000`;
      });

      text = escapeHtml(text);
      text = text.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
      text = text.replace(/__([^_]+)__/g, "<strong>$1</strong>");
      text = text.replace(/\*([^*]+)\*/g, "<em>$1</em>");
      text = text.replace(/_([^_]+)_/g, "<em>$1</em>");
      text = text.replace(/~~([^~]+)~~/g, "<del>$1</del>");

      return text.replace(/\u0000(\d+)\u0000/g, (_, idx) => replacements[Number(idx)] || "");
    }

    function renderMarkdown(text) {
      const normalized = String(text || "").replace(/\r\n/g, "\n");
      if (!normalized.trim()) return "";

      const codeBlocks = [];
      const withCodeTokens = normalized.replace(/```([\w-]+)?\n([\s\S]*?)```/g, (_, lang = "", code) => {
        const language = String(lang).trim();
        const classAttr = language ? ` class="language-${escapeHtml(language)}"` : "";
        const codeHtml = `<pre><code${classAttr}>${escapeHtml(code.replace(/\n$/, ""))}</code></pre>`;
        const idx = codeBlocks.push(codeHtml) - 1;
        return `@@CODEBLOCK_${idx}@@`;
      });

      const parseTableCells = (line) => {
        const raw = String(line || "").trim();
        if (!raw.includes("|")) return null;
        let row = raw;
        if (row.startsWith("|")) row = row.slice(1);
        if (row.endsWith("|")) row = row.slice(0, -1);
        const cells = row.split("|").map((cell) => cell.trim());
        return cells.length ? cells : null;
      };

      const isTableDelimiterRow = (line) => {
        const cells = parseTableCells(line);
        if (!cells || cells.length === 0) return false;
        return cells.every((cell) => /^:?-{3,}:?$/.test(cell));
      };

      const parseAlignments = (line, width) => {
        const cells = parseTableCells(line) || [];
        return Array.from({ length: width }, (_, idx) => {
          const cell = cells[idx] || "";
          const left = cell.startsWith(":");
          const right = cell.endsWith(":");
          if (left && right) return "center";
          if (right) return "right";
          return "left";
        });
      };

      const lines = withCodeTokens.split("\n");
      const chunks = [];
      const paragraph = [];
      let inList = false;

      const closeList = () => {
        if (inList) {
          chunks.push("</ul>");
          inList = false;
        }
      };

      const flushParagraph = () => {
        if (!paragraph.length) return;
        const body = renderInlineMarkdown(paragraph.join("\n")).replace(/\n/g, "<br>");
        chunks.push(`<p>${body}</p>`);
        paragraph.length = 0;
      };

      for (let i = 0; i < lines.length; i += 1) {
        const line = lines[i];
        const trimmed = line.trim();
        const codeMatch = /^@@CODEBLOCK_(\d+)@@$/.exec(trimmed);
        const headingMatch = /^(#{1,6})\s+(.+)$/.exec(trimmed);
        const quoteMatch = /^>\s?(.*)$/.exec(trimmed);
        const listMatch = /^[-*]\s+(.+)$/.exec(trimmed);
        const headerCells = parseTableCells(trimmed);

        if (!trimmed) {
          flushParagraph();
          closeList();
          continue;
        }
        if (codeMatch) {
          flushParagraph();
          closeList();
          chunks.push(codeBlocks[Number(codeMatch[1])] || "");
          continue;
        }
        if (headingMatch) {
          flushParagraph();
          closeList();
          const level = headingMatch[1].length;
          chunks.push(`<h${level}>${renderInlineMarkdown(headingMatch[2])}</h${level}>`);
          continue;
        }
        if (quoteMatch) {
          flushParagraph();
          closeList();
          chunks.push(`<blockquote>${renderInlineMarkdown(quoteMatch[1])}</blockquote>`);
          continue;
        }
        if (listMatch) {
          flushParagraph();
          if (!inList) {
            chunks.push("<ul>");
            inList = true;
          }
          chunks.push(`<li>${renderInlineMarkdown(listMatch[1])}</li>`);
          continue;
        }
        if (headerCells && i + 1 < lines.length && isTableDelimiterRow(lines[i + 1])) {
          flushParagraph();
          closeList();

          const colCount = headerCells.length;
          const alignments = parseAlignments(lines[i + 1], colCount);
          const renderRow = (cells, tag) =>
            Array.from({ length: colCount }, (_, colIdx) => {
              const align = alignments[colIdx] || "left";
              const alignClass = `md-align-${align}`;
              const value = cells[colIdx] || "";
              return `<${tag} class="${alignClass}">${renderInlineMarkdown(value)}</${tag}>`;
            }).join("");

          const bodyRows = [];
          let rowIdx = i + 2;
          while (rowIdx < lines.length) {
            const rowText = lines[rowIdx].trim();
            if (!rowText) break;
            if (isTableDelimiterRow(rowText)) break;
            const rowCells = parseTableCells(rowText);
            if (!rowCells) break;
            bodyRows.push(rowCells);
            rowIdx += 1;
          }

          const thead = `<thead><tr>${renderRow(headerCells, "th")}</tr></thead>`;
          const tbody = bodyRows.length
            ? `<tbody>${bodyRows.map((cells) => `<tr>${renderRow(cells, "td")}</tr>`).join("")}</tbody>`
            : "";
          chunks.push(`<div class="md-table-wrap"><table>${thead}${tbody}</table></div>`);
          i = rowIdx - 1;
          continue;
        }

        closeList();
        paragraph.push(line);
      }

      flushParagraph();
      closeList();

      return chunks
        .join("")
        .replace(/@@CODEBLOCK_(\d+)@@/g, (_, idx) => codeBlocks[Number(idx)] || "");
    }

    function setMessageContent(div, kind, text) {
      if (kind === "assistant") {
        div.dataset.rawText = text;
        div.innerHTML = renderMarkdown(text);
        return;
      }
      delete div.dataset.rawText;
      div.textContent = text;
    }

    function appendMessage(kind, text) {
      const div = document.createElement("div");
      div.className = `msg ${kind}`;
      setMessageContent(div, kind, text);
      const thinkingWidget = document.getElementById("nano-agents");
      const widgetVisible = thinkingWidget
        && thinkingWidget.parentElement === chatEl
        && thinkingWidget.style.display !== "none";

      if (widgetVisible) {
        chatEl.insertBefore(div, thinkingWidget);
      } else {
        chatEl.appendChild(div);
      }
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function setAgentThinking(thinking) {
      const widget = document.getElementById("nano-agents");
      const timeEl = document.getElementById("nano-time");
      if (!widget) return;

      if (thinking) {
        widget.style.display = "inline-flex";
        chatEl.appendChild(widget);
        chatEl.scrollTop = chatEl.scrollHeight;
        if (!nanoTimerInterval) {
          nanoElapsed = 0;
          if (timeEl) timeEl.textContent = "0s";
          nanoTimerInterval = setInterval(() => {
            nanoElapsed += 1;
            if (timeEl) timeEl.textContent = `${nanoElapsed}s`;
          }, 1000);
        }
      } else {
        widget.style.display = "none";
        if (nanoTimerInterval) {
          clearInterval(nanoTimerInterval);
          nanoTimerInterval = null;
        }
        if (thinkingTimeout) {
          clearTimeout(thinkingTimeout);
          thinkingTimeout = null;
        }
      }
    }

    function resetThinkingDebounce() {
      setAgentThinking(true);
      if (thinkingTimeout) clearTimeout(thinkingTimeout);
      thinkingTimeout = setTimeout(() => {
        setAgentThinking(false);
      }, 1500);
    }

    function appendOrUpdateStreamMessage(role, text) {
      let isStreamChunk = false;
      let parsedContent = "";

      try {
        const lines = text.split("\n");
        for (const line of lines) {
          const trimmed = line.trim();
          if (trimmed.startsWith("{") && trimmed.endsWith("}")) {
            const data = JSON.parse(trimmed);
            if (typeof data.content === "string") {
              isStreamChunk = true;
              parsedContent += data.content;
            }
          }
        }
      } catch {
        // Fall back to plain assistant message handling.
      }

      if (!isStreamChunk) {
        appendMessage(role, text);
        setAgentThinking(false);
        return;
      }

      resetThinkingDebounce();

      const messages = chatEl.querySelectorAll(".msg.assistant");
      if (messages.length > 0) {
        const last = messages[messages.length - 1];
        const nextRaw = `${last.dataset.rawText || ""}${parsedContent}`;
        setMessageContent(last, role, nextRaw);
        chatEl.scrollTop = chatEl.scrollHeight;
      } else {
        appendMessage(role, parsedContent);
      }
    }

    async function refreshStatus() {
      try {
        const r = await fetch("/api/status");
        const j = await r.json();
        apiStatusEl.innerHTML = `<span class="status-dot dot-ok"></span>${j.status}`;
        sessionCountEl.textContent = j.sessions;

        // Show update banner if a newer version is available
        if (j.latest_version && j.version) {
          const dismissed = sessionStorage.getItem("opencrust.update_dismissed");
          if (dismissed !== j.latest_version) {
            updateBannerText.innerHTML =
              `Update available: v${j.version} &rarr; v${j.latest_version.replace(/^v/, "")} &mdash; run <code>opencrust update</code>`;
            updateBanner.style.display = "";
          }
        } else {
          updateBanner.style.display = "none";
        }

        if (j.channels && j.channels.length > 0) {
          channelListEl.innerHTML = j.channels
            .map(ch => `<span class="channel-tag"><span class="status-dot dot-ok"></span>${ch}</span>`)
            .join("");
        } else {
          channelListEl.innerHTML = '<span class="no-channels">None configured</span>';
        }
      } catch {
        apiStatusEl.innerHTML = '<span class="status-dot dot-off"></span>unavailable';
        sessionCountEl.textContent = "-";
        channelListEl.innerHTML = '<span class="no-channels">-</span>';
      }

      loadProviders();
    }

    async function loadProviders() {
      try {
        const r = await fetch("/api/providers");
        const j = await r.json();
        providerData = j.providers || [];

        providerSelect.innerHTML = "";
        for (const p of providerData) {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = p.active ? p.display_name : `${p.display_name} (not configured)`;
          providerSelect.appendChild(opt);
        }

        // Restore saved selection, or pick the default
        const defaultProvider = providerData.find(p => p.is_default);
        const saved = selectedProvider || (defaultProvider ? defaultProvider.id : "");
        if (saved && [...providerSelect.options].some(o => o.value === saved)) {
          providerSelect.value = saved;
        }
        updateProviderUI();
      } catch {
        providerSelect.innerHTML = '<option value="">unavailable</option>';
        providerStatus.textContent = "";
        providerModelInput.value = "";
        providerModelInput.disabled = true;
        providerModelStatus.textContent = "";
        providerModelOptions.innerHTML = "";
      }
    }

    function updateModelUI(provider) {
      providerModelOptions.innerHTML = "";

      if (!provider) {
        providerModelInput.value = "";
        providerModelInput.placeholder = "Provider default model";
        providerModelInput.disabled = true;
        providerModelStatus.textContent = "";
        return;
      }

      const models = Array.isArray(provider.models)
        ? provider.models.filter(m => typeof m === "string" && m.trim().length > 0)
        : [];
      for (const modelName of models) {
        const opt = document.createElement("option");
        opt.value = modelName;
        providerModelOptions.appendChild(opt);
      }

      const savedModel = getSavedModelForProvider(provider.id);
      const defaultModel = typeof provider.model === "string" ? provider.model : "";
      const preferredModel = savedModel || defaultModel;
      providerModelInput.value = preferredModel;
      providerModelInput.placeholder = defaultModel
        ? `Provider default: ${defaultModel}`
        : "Provider default model";
      providerModelInput.disabled = !provider.active;

      if (!provider.active) {
        providerModelStatus.textContent = "Activate provider to choose a model.";
      } else if (models.length > 0) {
        providerModelStatus.textContent = `${models.length} model${models.length === 1 ? "" : "s"} available`;
      } else {
        providerModelStatus.textContent = "No model list available; type a model name to override.";
      }
    }

    function updateProviderUI() {
      const id = providerSelect.value;
      const p = providerData.find(x => x.id === id);
      if (!p) {
        providerStatus.textContent = "";
        providerKeySection.style.display = "none";
        updateModelUI(null);
        return;
      }
      if (p.active) {
        const tag = p.is_default ? "active, default" : "active";
        providerStatus.innerHTML = `<span class="status-dot dot-ok"></span>${tag}`;
        providerKeySection.style.display = "none";
      } else {
        providerStatus.innerHTML = `<span class="status-dot dot-off"></span>not configured`;
        providerKeySection.style.display = p.needs_api_key ? "" : "none";
      }
      selectedProvider = id;
      localStorage.setItem(providerStorage, id);
      updateModelUI(p);
    }

    providerSelect.addEventListener("change", () => {
      updateProviderUI();
      // If switching to an active provider, tell the backend to use it as default
      const p = providerData.find(x => x.id === providerSelect.value);
      if (p && p.active) {
        fetch("/api/providers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ provider_type: p.id, set_default: true }),
        }).then(() => loadProviders());
      }
    });

    providerActivateBtn.addEventListener("click", async () => {
      const id = providerSelect.value;
      const key = providerApiKey.value.trim();
      if (!key) return;
      const model = providerModelInput.value.trim();

      providerActivateBtn.textContent = "Activating...";
      providerActivateBtn.disabled = true;

      try {
        const payload = { provider_type: id, api_key: key, set_default: true };
        if (model) payload.model = model;
        const r = await fetch("/api/providers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const j = await r.json();
        if (r.ok) {
          providerApiKey.value = "";
          appendMessage("sys", `Provider ${id} activated.`);
          await loadProviders();
        } else {
          appendMessage("error", j.message || "Failed to activate provider.");
        }
      } catch (e) {
        appendMessage("error", `Failed to activate provider: ${e}`);
      } finally {
        providerActivateBtn.textContent = "Save & Activate";
        providerActivateBtn.disabled = false;
      }
    });

    providerModelInput.addEventListener("input", () => {
      const providerId = providerSelect.value;
      if (!providerId) return;
      setSavedModelForProvider(providerId, providerModelInput.value.trim());
    });

    function scheduleReconnect() {
      if (reconnectTimer) return;
      reconnectTimer = setTimeout(() => {
        reconnectTimer = null;
        connect();
      }, 2000);
    }

    function handleServerEvent(raw) {
      let evt;
      try {
        evt = JSON.parse(raw);
      } catch {
        appendMessage("sys", `Raw: ${raw}`);
        return;
      }

      if (evt.session_id) setSession(evt.session_id);

      switch (evt.type) {
        case "connected":
          if (evt.note) {
            appendMessage("sys", `Connected (${evt.note}).`);
          }
          refreshStatus();
          break;
        case "resumed":
          appendMessage("sys", `Session resumed (${evt.history_length ?? 0} messages in history).`);
          refreshStatus();
          break;
        case "message":
          appendOrUpdateStreamMessage("assistant", evt.content || "(empty response)");
          break;
        case "error":
          setAgentThinking(false);
          appendMessage("error", `${evt.code || "error"}: ${evt.message || "unknown error"}`);
          break;
        default:
          appendMessage("sys", `Event ${evt.type || "unknown"}: ${JSON.stringify(evt)}`);
      }
    }

    function connect() {
      if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
        return;
      }

      socket = new WebSocket(wsUrl());

      socket.onopen = () => {
        setConnectionState(true);
        if (sessionId) {
          socket.send(JSON.stringify({ type: "resume", session_id: sessionId }));
        } else {
          socket.send(JSON.stringify({ type: "init" }));
        }
      };

      socket.onmessage = (ev) => handleServerEvent(ev.data);

      socket.onclose = () => {
        setAgentThinking(false);
        setConnectionState(false);
        scheduleReconnect();
      };

      socket.onerror = () => {
        setAgentThinking(false);
        setConnectionState(false);
      };
    }

    function reconnectFresh() {
      if (reconnectTimer) {
        clearTimeout(reconnectTimer);
        reconnectTimer = null;
      }
      if (socket) {
        socket.onclose = null;
        try { socket.close(); } catch { }
        socket = null;
      }
      setConnectionState(false);
      connect();
    }

    function sendMessage() {
      const content = inputEl.value.trim();
      if (!content) return;

      if (!socket || socket.readyState !== WebSocket.OPEN) {
        appendMessage("error", "Not connected. Click Reconnect to try again.");
        return;
      }

      appendMessage("user", content);
      setAgentThinking(true);
      const msg = { content };
      const pid = providerSelect.value;
      if (pid) msg.provider = pid;
      const model = providerModelInput.value.trim();
      if (model) msg.model = model;
      socket.send(JSON.stringify(msg));
      inputEl.value = "";
      inputEl.focus();
    }

    sendBtn.addEventListener("click", sendMessage);
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    reconnectBtn.addEventListener("click", () => {
      reconnectFresh();
    });

    clearBtn.addEventListener("click", () => {
      setAgentThinking(false);
      chatEl.innerHTML = "";
      setSession("");
      reconnectFresh();
    });

    refreshBtn.addEventListener("click", refreshStatus);

    updateBannerClose.addEventListener("click", () => {
      updateBanner.style.display = "none";
      const ver = updateBannerText.textContent;
      // Extract version to remember dismissal for this version only
      const match = updateBannerText.innerHTML.match(/v([\d.]+)\s/);
      if (match) sessionStorage.setItem("opencrust.update_dismissed", match[1]);
    });

    authConnectBtn.addEventListener("click", () => {
      gatewayKey = keyGatewayEl.value.trim();
      if (gatewayKey) {
        localStorage.setItem(keyStorage, gatewayKey);
      }
      reconnectFresh();
    });

    if (themeToggleBtn) {
      themeToggleBtn.addEventListener("click", () => {
        const current = document.documentElement.getAttribute("data-theme") || "light";
        setTheme(current === "dark" ? "light" : "dark");
      });
    }

    // Navigation logic
    const navItems = {
      chat: document.getElementById("nav-chat"),
      mcps: document.getElementById("nav-mcps"),
      extensions: document.getElementById("nav-extensions")
    };

    const views = {
      chat: document.getElementById("view-chat"),
      mcps: document.getElementById("view-mcps"),
      extensions: document.getElementById("view-extensions")
    };

    function switchView(viewId) {
      // Update nav active states
      Object.entries(navItems).forEach(([id, el]) => {
        if (id === viewId) {
          el.classList.add("active");
        } else {
          el.classList.remove("active");
        }
      });

      // Update view visibility
      Object.entries(views).forEach(([id, el]) => {
        if (id === viewId) {
          el.style.display = "";
        } else {
          el.style.display = "none";
        }
      });
    }

    navItems.chat.addEventListener("click", () => switchView("chat"));
    navItems.mcps.addEventListener("click", () => switchView("mcps"));
    navItems.extensions.addEventListener("click", () => switchView("extensions"));

    // Boot: check if auth is required, then connect
    async function boot() {
      initTheme();
      requestAnimationFrame(() => {
        document.body.classList.add("ready");
      });
      setConnectionState(false);
      setSession(sessionId);
      refreshStatus();

      try {
        const r = await fetch("/api/auth-check");
        const j = await r.json();
        authRequired = j.auth_required;
      } catch {
        authRequired = false;
      }

      if (authRequired) {
        authSection.style.display = "";
        if (gatewayKey) {
          // Have a saved key  try connecting with it
          connect();
        } else {
          appendMessage("sys", "This gateway requires an API key. Enter it in the sidebar.");
        }
      } else {
        authSection.style.display = "none";
        connect();
      }
    }

    function initNanoAgents() {
      const bg = document.getElementById("nano-bg");
      const grid = document.getElementById("nano-grid");
      const widget = document.getElementById("nano-agents");
      if (!bg || !grid) return;
      if (widget) widget.style.display = "none";

      const colors = ["var(--brand)", "var(--brand-2)", "var(--online)", "var(--accent-line)"];
      const bits = [];
      for (let i = 0; i < 6; i++) {
        const bit = document.createElement("div");
        bit.className = "nano-bit";
        const size = Math.random() * 2 + 1;
        bit.style.width = `${size}px`;
        bit.style.height = `${size}px`;
        bit.style.left = `${Math.random() * 100}%`;
        bit.style.top = `${Math.random() * 100}%`;
        bit.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        bit.style.opacity = "0";
        bg.appendChild(bit);
        bits.push({ el: bit, id: Math.random() });
      }

      setInterval(() => {
        bits.forEach((b) => {
          if (Math.random() > 0.95) {
            b.el.style.left = `${Math.random() * 100}%`;
            b.el.style.top = `${Math.random() * 100}%`;
            b.el.style.opacity = "0";
          } else {
            b.el.style.opacity = String(Math.sin(Date.now() / 1500 + b.id * 10) * 0.1 + 0.1);
          }
        });
      }, 250);

      const agentColors = [
        ["var(--brand)", "var(--brand-2)"],
        ["var(--online)", "#4ade80"],
        ["var(--warn-text)", "var(--warn-edge)"],
        ["var(--ink-soft)", "var(--ink)"]
      ];

      const agentEls = [];
      let positions = [0, 1, 2, 3];

      for (let i = 0; i < 4; i++) {
        const agent = document.createElement("div");
        agent.className = "nano-agent";
        for (let p = 0; p < 4; p++) {
          const pixel = document.createElement("div");
          pixel.className = "nano-pixel";
          agent.appendChild(pixel);
        }
        grid.appendChild(agent);
        agentEls.push({ el: agent, colors: agentColors[i] });
      }

      setInterval(() => {
        agentEls.forEach((a) => {
          const pixels = a.el.children;
          for (let i = 0; i < pixels.length; i++) {
            pixels[i].style.backgroundColor = a.colors[Math.floor(Math.random() * a.colors.length)];
            pixels[i].style.opacity = String(0.7 + Math.random() * 0.3);
          }
        });
      }, 700);

      function getCoords(index) {
        return { x: (index % 2) * 12, y: Math.floor(index / 2) * 12 };
      }

      function updatePositions() {
        agentEls.forEach((a, i) => {
          const pos = positions[i];
          const coords = getCoords(pos);
          a.el.style.transform = `translate(${coords.x}px, ${coords.y}px)`;
        });
      }

      updatePositions();
      setInterval(() => {
        const next = [...positions];
        next.unshift(next.pop());
        positions = next;
        updatePositions();
      }, 2700);
    }

    boot();
    initNanoAgents();
  </script>
</body>

</html>
